<html>
  <head>
    <!--Load the AJAX API-->
    <script type="text/javascript" src="https://www.google.com/jsapi"></script>
    <script type="text/javascript">
      google.load('visualization', '1.1', {'packages':['controls']});
      google.setOnLoadCallback(drawDashboard);

      function drawDashboard() {
        var data = new google.visualization.DataTable();

        data.addColumn('datetime', 'Date');

        <%- totals = {} %>

        <%- for user in @users %>
          <%- totals[user.id] = 0 %>
          data.addColumn('number', '<%= "#{user.forename.capitalize} #{user.surname[0].capitalize}" %>');
        <%- end %>

        data.addRows([
          [
            new Date(<%= @start_date.to_i * 1000 %>),

            <%- for user in @users %>
              0,
            <%- end %>
          ]
        ]);

        data.addRows([

          <%- @timestamps.keys.sort.each do |timestamp| %>
            <%- data = @timestamps[timestamp] %>
            [
              new Date(<%= timestamp * 1000 %>),

              <%- for user in @users %>
                <%- delta = data[user.id] || 0 %>
                <%- totals[user.id] += delta %>
                <%= totals[user.id] %>,
              <%- end %>
            ],
          <%- end %>

        ]);

        data.addRows([
          [
            new Date(<%= @end_date.to_i * 1000 %>),

            <%- for user in @users %>
              <%- avg = totals[user.id] / @elapsed %>
              <%= avg * @duration %>,
            <%- end %>
          ]
        ]);

        // Create a range slider, passing some options
        var filter = new google.visualization.ControlWrapper({
          controlType: 'ChartRangeFilter',
          containerId: 'filter',
          state: {
            range: {
              start: new Date(<%= @start_date.to_i * 1000 %>),
              end: new Date(<%= Time.now.to_i * 1000 %>)
            },
          },
          options: {
            filterColumnIndex: 0,
          }
        });

        // Create a pie chart, passing some options
        var chart = new google.visualization.ChartWrapper({
          chartType: 'Line',
          containerId: 'chart',
          options: {
            height: 400,
            width: '100%',
            legend: {
              position: 'none'
            },
          }
        });

        var dashboard = new google.visualization.Dashboard($('#dashboard'));
        dashboard.bind(filter, chart);
        dashboard.draw(data);
      }
    </script>
  </head>

  <body>
    <style media="screen">
      #dashboard {
        width: 90%;
        margin: 0 auto;
      }

      #filter {
        height: 60px;
      }

      svg > g:first-of-type rect:first-of-type,
      svg > rect:first-of-type {
        fill: rgba(0, 0, 0, 0);
      }
    </style>

    <main>
      <div id="dashboard">
        <div id="chart"></div>
        <div id="filter"></div>
      </div>
    </main>
  </body>
</html>
